{"id":"antigravity-dashboard-100","title":"Google OAuth Token Retrieval \u0026 Security Enhancements","description":"Enhance the existing Google OAuth implementation to provide better token management, validation, retrieval capabilities, and address security gaps identified during code review.\n\n## Goals\n- Allow users to validate stored refresh tokens\n- Provide API endpoint to retrieve fresh access tokens\n- Make OAuth callback port configurable\n- Improve error messages and recovery flows\n- Revoke tokens at Google when accounts are deleted\n- Add proper cache-control headers on auth endpoints\n- Implement proactive token refresh at 80% lifetime","status":"open","priority":0,"issue_type":"epic","created_at":"2026-01-19T20:48:00Z","created_by":"prd-import","updated_at":"2026-01-19T20:48:00Z","labels":["feature","google-auth","ralph"]}
{"id":"antigravity-dashboard-101","title":"US-001: Add Token Validation Endpoint","description":"As a user, I want to verify that my stored refresh tokens are still valid so that I can proactively fix authentication issues before they impact quota monitoring.\n\n## Acceptance Criteria\n- [ ] Add POST /api/accounts/:email/validate endpoint in server.ts\n- [ ] Endpoint attempts to refresh the access token using the stored refresh token via quotaService.getAccessToken()\n- [ ] Returns { success: true, valid: true, expiresIn: number } on success\n- [ ] Returns { success: true, valid: false, error: string } with specific error (expired, revoked, etc.) on failure\n- [ ] Does NOT expose the actual tokens in the response\n- [ ] Rate limited to 1 request per account per 10 seconds using existing rate limit patterns\n- [ ] pnpm run lint passes\n- [ ] pnpm run build passes\n\n## Notes\nUse quotaService.getAccessToken() which already handles refresh. Catch errors and return structured response.","status":"in_progress","priority":0,"issue_type":"task","created_at":"2026-01-19T20:48:00Z","created_by":"prd-import","updated_at":"2026-01-20T00:13:01.123038331+03:00","labels":["backend","google-auth","ralph"],"dependencies":[{"issue_id":"antigravity-dashboard-101","depends_on_id":"antigravity-dashboard-100","type":"parent-child","created_at":"2026-01-20T00:10:38.613690888+03:00","created_by":"Omer Faruk Oruc"}]}
{"id":"antigravity-dashboard-102","title":"US-002: Add Token Retrieval API","description":"As a developer, I want to retrieve a fresh access token for a specific account so that I can use it with external tools that need Google Cloud authentication.\n\n## Acceptance Criteria\n- [ ] Add GET /api/accounts/:email/token endpoint in server.ts\n- [ ] Returns { success: true, accessToken: string, expiresAt: number } on success\n- [ ] Requires DASHBOARD_SECRET authentication when configured (use existing auth middleware pattern)\n- [ ] Automatically refreshes token if expired or within 1 minute of expiry\n- [ ] Returns 404 with { success: false, error: 'Account not found' } if account not found\n- [ ] Returns 401 with { success: false, error: string } if token refresh fails\n- [ ] Add rate limiting (10 requests per minute per account)\n- [ ] pnpm run lint passes\n- [ ] pnpm run build passes\n\n## Notes\nSecurity: Never return refresh tokens. Access token endpoint is sensitive.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-19T20:48:00Z","created_by":"prd-import","updated_at":"2026-01-19T20:48:00Z","labels":["backend","google-auth","ralph"],"dependencies":[{"issue_id":"antigravity-dashboard-102","depends_on_id":"antigravity-dashboard-100","type":"parent-child","created_at":"2026-01-20T00:10:48.614606419+03:00","created_by":"Omer Faruk Oruc"}]}
{"id":"antigravity-dashboard-103","title":"US-003: Make OAuth Callback Port Configurable","description":"As a user, I want to configure the OAuth callback port so that I can avoid conflicts with other services using port 51121.\n\n## Acceptance Criteria\n- [ ] Add OAUTH_CALLBACK_PORT to process.env handling in server.ts\n- [ ] Default to 51121 for backward compatibility when not set\n- [ ] Update .env.example with OAUTH_CALLBACK_PORT=51121 and documentation comment\n- [ ] Update OAUTH_REDIRECT_URI constant to use configured port\n- [ ] Update activeAuthServer.listen() call to use configured port\n- [ ] Log the configured port on OAuth callback server startup\n- [ ] pnpm run lint passes\n- [ ] pnpm run build passes\n\n## Notes\nCurrent hardcoded: const OAUTH_CALLBACK_PORT = 51121 at line 397 in server.ts","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-19T20:48:00Z","created_by":"prd-import","updated_at":"2026-01-19T20:48:00Z","labels":["backend","google-auth","ralph"],"dependencies":[{"issue_id":"antigravity-dashboard-103","depends_on_id":"antigravity-dashboard-100","type":"parent-child","created_at":"2026-01-20T00:10:48.663838602+03:00","created_by":"Omer Faruk Oruc"}]}
{"id":"antigravity-dashboard-104","title":"US-004: Implement Token Revocation on Account Deletion","description":"As a security-conscious user, when I delete an account from the dashboard, the refresh token should be revoked at Google so that it cannot be reused.\n\n## Acceptance Criteria\n- [ ] Before deleting account from JSON file in accountsFile.ts removeAccount(), call Google's revoke endpoint\n- [ ] Use: POST https://oauth2.googleapis.com/revoke with body: token=\u003crefreshToken\u003e\n- [ ] Handle revocation failures gracefully - still delete locally but log warning\n- [ ] Also add revocation to bulk delete in removeAccounts() method\n- [ ] Add try/catch around revocation to not block deletion on network errors\n- [ ] pnpm run lint passes\n- [ ] pnpm run build passes\n\n## Notes\nLocation: apps/backend/src/services/accountsFile.ts removeAccount() and removeAccounts()","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-19T20:48:00Z","created_by":"prd-import","updated_at":"2026-01-19T20:48:00Z","labels":["backend","google-auth","ralph","security"],"dependencies":[{"issue_id":"antigravity-dashboard-104","depends_on_id":"antigravity-dashboard-100","type":"parent-child","created_at":"2026-01-20T00:10:48.709352257+03:00","created_by":"Omer Faruk Oruc"}]}
{"id":"antigravity-dashboard-105","title":"US-005: Add Cache-Control Headers on Auth Endpoints","description":"As a security-conscious user, OAuth-related endpoints should have proper cache-control headers to prevent browsers and proxies from caching tokens.\n\n## Acceptance Criteria\n- [ ] Add middleware for /api/auth/* and /api/accounts/*/token routes\n- [ ] Set Cache-Control: no-store, no-cache, must-revalidate header\n- [ ] Set Pragma: no-cache header for HTTP/1.0 compatibility\n- [ ] Apply to GET /api/accounts/:email/token endpoint\n- [ ] Apply to GET /api/auth/google/url endpoint\n- [ ] pnpm run lint passes\n- [ ] pnpm run build passes\n\n## Notes\nAdd before route handlers or use app.use() with path prefix","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-19T20:48:00Z","created_by":"prd-import","updated_at":"2026-01-19T20:48:00Z","labels":["backend","google-auth","ralph","security"],"dependencies":[{"issue_id":"antigravity-dashboard-105","depends_on_id":"antigravity-dashboard-100","type":"parent-child","created_at":"2026-01-20T00:10:48.754112159+03:00","created_by":"Omer Faruk Oruc"}]}
{"id":"antigravity-dashboard-106","title":"US-006: Implement Proactive Token Refresh","description":"As a user, access tokens should be refreshed proactively before they expire to prevent failed API calls during the refresh window.\n\n## Acceptance Criteria\n- [ ] Modify quotaService.ts refreshAccessToken() to refresh at 80% of token lifetime\n- [ ] For 3600s tokens, refresh at 2880s (48 minutes) instead of current 3540s (59 minutes)\n- [ ] Calculate threshold as: Date.now() + (expiresIn * 1000 * 0.2) instead of + 60000\n- [ ] Add debug log when proactive refresh occurs\n- [ ] pnpm run lint passes\n- [ ] pnpm run build passes\n\n## Notes\nCurrent code at quotaService.ts line 138 uses 60000ms (1 minute) buffer","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-19T20:48:00Z","created_by":"prd-import","updated_at":"2026-01-19T20:48:00Z","labels":["backend","google-auth","ralph"],"dependencies":[{"issue_id":"antigravity-dashboard-106","depends_on_id":"antigravity-dashboard-100","type":"parent-child","created_at":"2026-01-20T00:10:48.80085301+03:00","created_by":"Omer Faruk Oruc"}]}
{"id":"antigravity-dashboard-107","title":"US-007: Add Test Token Button to Frontend","description":"As a user, I want to test if an account's token is working from the dashboard UI so that I can quickly identify authentication issues.\n\n## Acceptance Criteria\n- [ ] Add 'Test' button/icon to AccountRow component in AccountsPage.tsx\n- [ ] Use a test tube or checkmark icon from lucide-react\n- [ ] Button calls POST /api/accounts/:email/validate endpoint\n- [ ] Show loading spinner while validating (use existing spinner patterns)\n- [ ] Show green checkmark icon with 'Valid' title/tooltip on success\n- [ ] Show red X icon with error message title/tooltip on failure\n- [ ] Result icon visible for 5 seconds then returns to normal test button\n- [ ] pnpm run lint passes\n- [ ] pnpm run build passes\n- [ ] Verify in browser that button appears and works correctly\n\n## Notes\nAdd to AccountRow actions alongside existing Refresh and Delete buttons","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-19T20:48:00Z","created_by":"prd-import","updated_at":"2026-01-19T20:48:00Z","labels":["frontend","google-auth","ralph","ui"],"dependencies":[{"issue_id":"antigravity-dashboard-107","depends_on_id":"antigravity-dashboard-100","type":"parent-child","created_at":"2026-01-20T00:10:48.84551102+03:00","created_by":"Omer Faruk Oruc"}]}
{"id":"antigravity-dashboard-108","title":"US-008: Add Token Error State to Account Display","description":"As a user, when a token becomes invalid I want to see a clear visual indicator so that I know which accounts need re-authentication.\n\n## Acceptance Criteria\n- [ ] Add tokenError field to LocalAccount type in web/src/types/index.ts\n- [ ] When token validation fails, emit WebSocket event: { type: 'token_error', data: { email, error } }\n- [ ] Add WebSocket handler in useDashboardStore to update account's tokenError state\n- [ ] Show red warning icon/badge on AccountRow when tokenError is set\n- [ ] Tooltip on warning icon shows the error message\n- [ ] Clicking the warning icon opens Google OAuth flow for that account\n- [ ] Clear tokenError state after successful re-authentication\n- [ ] pnpm run lint passes\n- [ ] pnpm run build passes\n- [ ] Verify in browser that error state appears correctly\n\n## Notes\nRequires adding WebSocket event type and frontend state management","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-19T20:48:00Z","created_by":"prd-import","updated_at":"2026-01-19T20:48:00Z","labels":["frontend","google-auth","ralph","ui"],"dependencies":[{"issue_id":"antigravity-dashboard-108","depends_on_id":"antigravity-dashboard-100","type":"parent-child","created_at":"2026-01-20T00:10:48.889447259+03:00","created_by":"Omer Faruk Oruc"}]}
{"id":"antigravity-dashboard-109","title":"US-009: Add Bulk Token Validation Endpoint","description":"As a user with many accounts, I want to validate all tokens at once so that I can quickly identify which accounts need re-authentication.\n\n## Acceptance Criteria\n- [ ] Add POST /api/accounts/validate-all endpoint in server.ts\n- [ ] Returns array of { email: string, valid: boolean, error?: string }\n- [ ] Validates tokens in parallel using Promise.allSettled with concurrency limit of 5\n- [ ] Use p-limit or similar pattern for concurrency control\n- [ ] Rate limited to 1 request per 30 seconds globally\n- [ ] pnpm run lint passes\n- [ ] pnpm run build passes\n\n## Notes\nReuse validation logic from US-001 endpoint","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-19T20:48:00Z","created_by":"prd-import","updated_at":"2026-01-19T20:48:00Z","labels":["backend","google-auth","ralph"],"dependencies":[{"issue_id":"antigravity-dashboard-109","depends_on_id":"antigravity-dashboard-100","type":"parent-child","created_at":"2026-01-20T00:10:48.934908665+03:00","created_by":"Omer Faruk Oruc"}]}
{"id":"antigravity-dashboard-110","title":"US-010: Add Validate All Button to Frontend","description":"As a user with many accounts, I want a 'Validate All' button to check all tokens at once from the UI.\n\n## Acceptance Criteria\n- [ ] Add 'Validate All' button to AccountsPage header next to 'Add Account' button\n- [ ] Button calls POST /api/accounts/validate-all endpoint\n- [ ] Show progress indicator (spinner or progress bar) during bulk validation\n- [ ] After completion, highlight accounts with invalid tokens using tokenError state\n- [ ] Show toast/notification summarizing results: 'X of Y tokens valid'\n- [ ] pnpm run lint passes\n- [ ] pnpm run build passes\n- [ ] Verify in browser that button and results display work correctly\n\n## Notes\nReuse tokenError state from US-008","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-19T20:48:00Z","created_by":"prd-import","updated_at":"2026-01-19T20:48:00Z","labels":["frontend","google-auth","ralph","ui"],"dependencies":[{"issue_id":"antigravity-dashboard-110","depends_on_id":"antigravity-dashboard-100","type":"parent-child","created_at":"2026-01-20T00:10:48.977240866+03:00","created_by":"Omer Faruk Oruc"}]}
